name: CI - Build Docker Images

on:
  push:
    branches: [ "**" ]  # Build on every branch
  pull_request:
    branches: [ main ]

jobs:
  build:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        component: [assistant, mcp-server, ui]
      fail-fast: false  # Continue building other components even if one fails

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up Docker Buildx
      uses: docker/setup-buildx-action@v3

    - name: Build Docker image
      uses: docker/build-push-action@v5
      with:
        context: ./${{ matrix.component }}
        push: false
        tags: |
          pooch-palace-${{ matrix.component }}:latest
          pooch-palace-${{ matrix.component }}:${{ github.sha }}
          pooch-palace-${{ matrix.component }}:${{ github.ref_name }}
        cache-from: type=gha
        cache-to: type=gha,mode=max
        
    - name: Test Docker image
      run: |
        # Test that the image was built successfully
        docker images pooch-palace-${{ matrix.component }}:latest
        
        # Basic smoke test - ensure container can start
        if [ "${{ matrix.component }}" = "ui" ]; then
          # For UI, test that it can start (will exit quickly but that's expected)
          timeout 10s docker run --rm pooch-palace-${{ matrix.component }}:latest || true
        fi

  test:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    - name: Set up JDK 25
      uses: actions/setup-java@v4
      with:
        java-version: '25'
        distribution: 'temurin'

    - name: Cache Maven dependencies
      uses: actions/cache@v4
      with:
        path: ~/.m2
        key: ${{ runner.os }}-m2-${{ hashFiles('**/pom.xml') }}
        restore-keys: ${{ runner.os }}-m2

    - name: Test Assistant Service
      run: |
        cd assistant
        mvn clean test

    - name: Test MCP Server
      run: |
        cd mcp-server
        mvn clean test

    - name: Set up Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
        cache: 'npm'
        cache-dependency-path: ui/package-lock.json

    - name: Test UI
      run: |
        cd ui
        npm ci
        npm run build:all
        npm run test:ci

    - name: Upload UI Test Results
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: ui-test-results
        path: |
          ui/test-results/
          ui/coverage/
        retention-days: 30

    - name: Upload Coverage to Codecov
      uses: codecov/codecov-action@v4
      if: always()
      with:
        file: ui/coverage/lcov.info
        flags: ui
        name: ui-coverage
        fail_ci_if_error: false

    - name: Comment Test Results on PR
      uses: actions/github-script@v7
      if: github.event_name == 'pull_request' && always()
      with:
        script: |
          const fs = require('fs');
          const path = require('path');
          
          try {
            const resultsPath = 'ui/test-results/results.json';
            if (fs.existsSync(resultsPath)) {
              const results = JSON.parse(fs.readFileSync(resultsPath, 'utf8'));
              const { numTotalTests, numPassedTests, numFailedTests, success } = results;
              
              const coveragePath = 'ui/coverage/coverage-summary.json';
              let coverageInfo = '';
              if (fs.existsSync(coveragePath)) {
                const coverage = JSON.parse(fs.readFileSync(coveragePath, 'utf8'));
                const { lines, functions, branches, statements } = coverage.total;
                coverageInfo = `
              ## Coverage Report
              - Lines: ${lines.pct}%
              - Functions: ${functions.pct}%
              - Branches: ${branches.pct}%
              - Statements: ${statements.pct}%
              `;
              }
              
              const body = `## UI Test Results ${success ? '‚úÖ' : '‚ùå'}
              
              - Total Tests: ${numTotalTests}
              - Passed: ${numPassedTests}
              - Failed: ${numFailedTests}
              ${coverageInfo}
              
              ${!success ? '‚ùå Some tests failed. Please check the test results for details.' : '‚úÖ All tests passed!'}
              `;
              
              github.rest.issues.createComment({
                issue_number: context.issue.number,
                owner: context.repo.owner,
                repo: context.repo.repo,
                body: body
              });
            }
          } catch (error) {
            console.log('Could not post test results comment:', error.message);
          }

  summary:
    runs-on: ubuntu-latest
    needs: [build, test]
    if: always()
    
    steps:
    - name: Check build results
      run: |
        echo "Build job result: ${{ needs.build.result }}"
        echo "Test job result: ${{ needs.test.result }}"
        
        if [[ "${{ needs.build.result }}" == "success" && "${{ needs.test.result }}" == "success" ]]; then
          echo "‚úÖ All Docker images built successfully and all tests passed!"
          echo "üêï Pooch Palace is ready for deployment!"
        elif [[ "${{ needs.build.result }}" == "success" ]]; then
          echo "‚úÖ All Docker images built successfully"
          echo "‚ùå Some tests failed"
          exit 1
        elif [[ "${{ needs.test.result }}" == "success" ]]; then
          echo "‚úÖ All tests passed"
          echo "‚ùå Some Docker builds failed"
          exit 1
        else
          echo "‚ùå Both builds and tests had issues"
          exit 1
        fi